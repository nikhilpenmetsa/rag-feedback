# RAG Feedback System

A sample serverless solution for AI chat applications with integrated user feedback capabilities, built on AWS.

## Overview

This project demonstrates how to implement user feedback integration in AI chat applications. It consists of two main stacks:

1. **Backend Stack**: APIs and services that power the LLM model interactions and handle user feedback for the responses generated by the LLM (capture and retrieval)
2. **Frontend Stack**: Single Page Application (SPA) with a user interface that integrates with the backend APIs

The system includes user authentication via Amazon Cognito, with different permission levels. Power users (reviewers) can review feedback submitted by regular users, add comments, and mark items as reviewed.

## Architecture

### Backend Components

- **AWS Lambda Functions**:
  - `feedback-lambda`: Processes conversation requests with Claude AI
  - `feedback-writer-lambda`: Stores user feedback in DynamoDB
  - `feedback-reader-lambda`: Retrieves feedback data for analysis
  - `feedback-reviewer-lambda`: Allows reviewers to add comments to feedback
  
- **Amazon Bedrock**: Uses Claude model to generate responses via the Converse API
  
- **Amazon Cognito**: Manages user authentication and authorization
  - Regular users: Can submit feedback
  - Reviewer users: Can review and comment on feedback
  
- **Amazon API Gateway**: Provides HTTP endpoints with Cognito authorization:
  - `/conversation`: For AI conversations
  - `/submit-feedback`: For submitting user feedback
  - `/feedback-data`: For retrieving feedback data
  - `/review-feedback`: For reviewers to add comments to feedback
  
- **Amazon DynamoDB**: Stores user feedback with conversation context and user information

### Frontend Components

- **Single Page Application (SPA)**:
  - User authentication with Cognito
  - Clean, modern chat interface
  - User identification display
  - Thumbs up/down feedback buttons
  - Text feedback form
  - Reviewer dashboard for power users
  
- **Amazon S3 & CloudFront**: Hosts and delivers the SPA

## Features

- **AI Conversations**: Interact with Claude AI through a simple chat interface
- **User Authentication**: Secure login with different permission levels
- **User Identification**: Display user name in the interface
- **User Feedback Collection**: 
  - Capture positive/negative feedback with optional text comments
  - Store feedback with conversation context for analysis
- **Feedback Analysis**: Query and analyze feedback data by conversation or type
- **Feedback Review System**: Allow power users to review and comment on feedback
- **CORS Support**: Properly configured for cross-origin requests
- **Comprehensive Logging**: Detailed logs for troubleshooting

## Project Structure

```
rag-feedback/
├── cloudformation/       # CloudFormation templates
│   └── template.yaml     # Main backend stack template
├── scripts/              # Deployment and utility scripts
│   ├── deploy.ps1        # Main deployment script
│   ├── update-lambda.ps1 # Script to update Lambda code
│   ├── create_users.py   # Python script to create Cognito users
│   ├── create_users.sh   # Bash script to run create_users.py
│   ├── create_users.ps1  # PowerShell script to run create_users.py
│   └── sample_users.json # Sample user data for create_users.py
├── src/                  # Lambda function source code
│   ├── app.py            # Conversation Lambda
│   ├── feedback_writer.py # Feedback submission Lambda
│   ├── feedback_reader.py # Feedback retrieval Lambda
│   ├── feedback_reviewer.py # Feedback reviewer Lambda
│   └── requirements.txt  # Python dependencies
└── spa/                  # Single Page Application
    ├── cloudformation/   # SPA infrastructure
    │   └── spa-template.yaml # CloudFront/S3 template
    ├── public/           # SPA static files
    │   ├── index.html    # Main HTML file
    │   ├── login.html    # Login page
    │   ├── feedback.html # Feedback dashboard
    │   ├── styles.css    # CSS styling
    │   ├── app.js        # Main application JavaScript
    │   ├── auth.js       # Authentication JavaScript
    │   ├── feedback.js   # Feedback dashboard JavaScript
    │   └── config.js     # Configuration file
    └── scripts/          # SPA deployment scripts
        ├── deploy.ps1    # SPA deployment script
        ├── update_config.py # Script to update config.js
        ├── update_config.ps1 # PowerShell wrapper for update_config.py
        └── update_config.sh  # Bash wrapper for update_config.py
```

## Deployment

### Backend Deployment

```powershell
cd scripts
.\deploy.ps1
```

To update Lambda functions without redeploying the entire stack:

```powershell
cd scripts
.\update-lambda.ps1
```

### Creating Users

After deploying the backend stack, you can create users with the provided script:

```powershell
cd scripts
.\create_users.ps1
```

For Linux/macOS:

```bash
cd scripts
./create_users.sh
```

This will create sample users with different permission levels:
- Regular users: user1@example.com, user2@example.com, user3@example.com
- Reviewer users: reviewer1@example.com, reviewer2@example.com

### Frontend Deployment

```powershell
cd spa/scripts
.\deploy.ps1
```

After deploying the frontend, update the configuration with the backend endpoints:

```powershell
cd spa/scripts
.\update_config.ps1
```

## API Endpoints

### Conversation API

```
POST /conversation
{
  "message": "Your message here"
}
```

### Feedback Submission API

```
POST /submit-feedback
{
  "conversation_id": "uuid",
  "feedback_type": "positive|negative|neutral",
  "feedback_text": "Optional feedback text",
  "original_query": "User's original question",
  "llm_response": "AI's response"
}
```

### Feedback Retrieval API

```
GET /feedback-data
GET /feedback-data?conversation_id=uuid
GET /feedback-data?feedback_type=positive
```

### Feedback Review API

```
POST /review-feedback
{
  "feedback_id": "uuid",
  "reviewer_comments": "Comments from reviewer"
}
```

## Authentication Flow

1. Users log in through the login.html page using Cognito authentication
2. Upon successful login, a JWT token is stored in the browser's localStorage
3. The token is sent with each API request in the Authorization header
4. API Gateway validates the token using Cognito authorizers
5. Lambda functions extract user information from the token
6. User permissions determine available features and data access

## Data Model

### Feedback Item

```json
{
  "id": "uuid",
  "conversation_id": "uuid",
  "feedback_type": "positive|negative|neutral",
  "feedback_text": "User feedback text",
  "original_query": "User's question",
  "llm_response": "AI's response",
  "timestamp": "ISO datetime",
  "user_id": "user's email or ID",
  "reviewed": false,
  "reviewer_comments": "Comments from reviewer",
  "reviewer_id": "reviewer's email or ID"
}
```

## Use Cases

- **Customer Support**: Enhance AI-powered support systems with user satisfaction tracking
- **Content Generation**: Improve AI content creation by analyzing user feedback
- **Knowledge Base Systems**: Refine RAG (Retrieval-Augmented Generation) systems based on user feedback
- **Product Development**: Gather insights on AI feature performance and user satisfaction
- **Quality Assurance**: Enable reviewers to validate and improve AI responses based on user feedback

## Benefits

- **Continuous Improvement**: Use feedback data to fine-tune AI models and improve responses
- **User Experience**: Create more responsive and user-centered AI applications
- **Performance Metrics**: Track AI system performance through quantifiable feedback data
- **Quality Control**: Implement a review process for AI-generated content
- **User Management**: Control access to feedback data with different permission levels